# 分布式设计

## 弹力设计

### 隔离设计

#### 按服务种类

![image-20230825112651249](/Users/xiongyiru/Library/Application Support/typora-user-images/image-20230825112651249.png)

如上述例子，系统按照服务的种类被分为三个模块：用户、商品、社区

**优点：**

​	系统隔离优秀。从接入层到应用层再到数据层，三层实现完全隔离。在物理的角度上，板块之间的故障不会互相影响

**存在的问题**

- 同时需要多板块数据的时候，需要同时调用几个服务，降低响应时间

  （吞吐量在这样的场景下其实反而可以得到提高）

- 需要把数据抽取到数据仓库中进行计算，增加了数据合并的复杂度。

  （需要框架或中间件来进行）

- 当业务流程或是逻辑需要跨模块的时候，板块之间的故障会互相牵连，阻塞某个进程，最终导致整个业务故障无法进行

  （提高系统可用性，将业务流程设计成step-by-step，保证每一步的数据可以保存，在故障恢复后继续）

- 跨板块的交互较复杂。

  （需要类似pub/sub高可用、持久化的消息订阅通知中间件来打通模块之间的交互）

- 存在多板块的分布式事务问题。

  （使用类似“”二阶段提交“的方案）

Based on experience, 该类系统通常可以引入大量的**异步处理系统**。

#### 按用户请求分离

![image-20230825113915287](/Users/xiongyiru/Library/Application Support/typora-user-images/image-20230825113915287.png)

**多组户：同一服务，不同用户**

**优点**：

- 将用户分成不同的组，后端的同一个服务根据不同组分成不同的实例，当某一实例挂掉的时候，只会影响部分用户。

- 可以为特殊的组户定制化独立的服务实例

**存在的问题**

- 引入系统的设计复杂度。
- More 隔离，more 资源浪费
- More 共享，more 程序设计复杂度

**通常存在的多组户设计方式**

1. 完全独立的设计。每个租户有自己完全独立的服务和数据。

2. 独立的数据分区，共享的服务。多租户的服务是共享的，但数据是分开隔离的。

3. 共享的服务，共享的数据分区。每个租户的数据和服务都是共享的。

   ![image-20230825114812076](/Users/xiongyiru/Library/Application Support/typora-user-images/image-20230825114812076.png)



 一般来说，折衷方式：服务是共享的，数据通过分区来隔离，而对于一些比较重要的租户（需要好的隔离性），则使用完全独立的方式

#### 设计考量

1. 我们需要定义好隔离业务的大小和粒度，过大和过小都不好。这需要认真地做业务上的需求和系统分析。
2. 无论是做系统板块还是多租户的隔离，你都需要考虑系统的复杂度、成本、性能、资源使用的问题，找到一个合适的均衡方案，或是分布实施的方案尤其重要，这其中需要你定义好要什么和不要什么。因为，我们不可能做出一个什么都能满足的系统。
3. 隔离模式需要配置一些高可用、重试、异步、消息中间件，流控、熔断等设计模式的方式配套使用。
4. 不要忘记了分布式系统中的运维的复杂度的提升，要能驾驭得好的话，还需要很多自动化运维的工具，尤其是使用像容器或是虚拟机这样的虚拟化技术可以帮助我们更方便地管理，和对比资源更好地利用。否则做出来了也管理不好。
5. 最后，你需要一个非常完整的能够看得到所有服务的监控系统，这点非常重要。

### 异步通讯

异步相比于同步，除了**提高吞吐量**，还可以**实现服务之间的解耦**

#### 异步通讯的三种方式

- 请求响应式

​		sender直接请求receiver，被请求方接受到请求后直接返回结果——“收到请求，正在处理中”

​		如何处理返回结果？

​		1.发送方轮询

​		2.发送方注册回调方法，接收方处理完之后再回调请求方。（a.g.支付宝）

​		但是呢...发送方和请求方在这个方式下没有完全解耦。是发送方依赖于接收方，并且要把自己的回调发送给接收方，处理完后回调。

- 订阅
- broker